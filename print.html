<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>The Kona Book</title>
        <meta name="robots" content="noindex">


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="intro.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="fpp-dev/intro.html"><strong aria-hidden="true">2.</strong> Fault Proof Program Development</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="fpp-dev/env.html"><strong aria-hidden="true">2.1.</strong> Environment</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="fpp-dev/targets.html"><strong aria-hidden="true">2.1.1.</strong> Supported Targets</a></li></ol></li><li class="chapter-item expanded "><a href="fpp-dev/prologue.html"><strong aria-hidden="true">2.2.</strong> Prologue</a></li><li class="chapter-item expanded "><a href="fpp-dev/execution.html"><strong aria-hidden="true">2.3.</strong> Execution</a></li><li class="chapter-item expanded "><a href="fpp-dev/epilogue.html"><strong aria-hidden="true">2.4.</strong> Epilogue</a></li></ol></li><li class="chapter-item expanded "><a href="glossary.html"><strong aria-hidden="true">3.</strong> Glossary</a></li><li class="chapter-item expanded "><a href="CONTRIBUTING.html"><strong aria-hidden="true">4.</strong> Contributing</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">The Kona Book</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="kona-book"><a class="header" href="#kona-book">Kona Book</a></h1>
<p><em>Documentation for the Kona project.</em></p>
<p><a href="https://github.com/kona-rs/kona"><img src="https://img.shields.io/badge/GitHub%20Repo-kona-green?logo=github"></a></p>
<blockquote>
<p>📖 <code>kona</code> is in active development, and is not yet ready for use in production. During development, this book will evolve quickly and may contain inaccuracies.</p>
<p>Please <a href="https://github.com/anton-rs/kona/issues/new">open an issue</a> if you find any errors or have any suggestions for improvements, and also feel free to <a href="https://github.com/anton-rs/kona/tree/main/CONTRIBUTING.md">contribute</a> to the project!</p>
</blockquote>
<h2 id="introduction"><a class="header" href="#introduction">Introduction</a></h2>
<p>Kona is a suite of libraries and build pipelines for developing verifiable Rust programs targeting
<a href="./glossary.html#fault-proof-vm">Fault Proof VMs</a>
.</p>
<p>It is built and maintained by members of <a href="https://github.com/ethereum-optimism">OP Labs</a> as well as open source contributors, and is licensed under the MIT License.</p>
<p>Kona provides tooling and abstractions around low-level syscalls, memory management, and other common structures that authors of verifiable programs
will need to interact with. It also provides build pipelines for compiling <code>no_std</code> Rust programs to a format that can be executed by supported
Fault Proof VM targets.</p>
<h2 id="goals-of-kona"><a class="header" href="#goals-of-kona">Goals of Kona</a></h2>
<p><strong>1. Composability</strong></p>
<p>Kona provides a common set of tools and abstractions for developing verifiable Rust programs on top of several supported Fault Proof VM targets. This is done
to ensure that programs written for one supported FPVM can be easily ported to another supported FPVM, and that the ecosystem of programs built on top of these targets
can be easily shared and reused.</p>
<p><strong>2. Safety</strong></p>
<p>Through standardization of these low-level system interfaces and build pipelines, Kona seeks to increase coverage over the low-level operations that are
required to build on top of a FPVM.</p>
<p><strong>3. Developer Experience</strong></p>
<p>Building on top of custom Rust targets can be difficult, especially when the target is nascent and tooling is not yet mature. Kona seeks to improve this
experience by standardizing and streamlining the process of developing and compiling verifiable Rust programs, targeted at supported FPVMs.</p>
<p><strong>4. Performance</strong></p>
<p>Kona is opinionated in that it favors <code>no_std</code> Rust programs for embedded FPVM development, for both performance and portability. In contrast with alternative approaches, such
as the <a href="https://github.com/ethereum-optimism/optimism/tree/develop/op-program"><code>op-program</code></a> using the Golang <code>MIPS32</code> target, <code>no_std</code> Rust programs produce much smaller binaries, resulting in fewer instructions
that need to be executed on the FPVM. In addition, this offers developers more low-level control over interactions with the FPVM kernel, which can be useful
for optimizing performance-critical code.</p>
<h2 id="development-status"><a class="header" href="#development-status">Development Status</a></h2>
<p><strong>Kona is currently in active development, and is not yet ready for use in production.</strong></p>
<h2 id="contributing"><a class="header" href="#contributing">Contributing</a></h2>
<p>Contributors are welcome! Please see the <a href="https://github.com/anton-rs/kona/tree/main/CONTRIBUTING.md">contributing guide</a> for more information.</p>
<!-- External -->
<!-- Kona links -->
<!-- People -->
<div style="break-before: page; page-break-before: always;"></div><h1 id="fault-proof-program-development"><a class="header" href="#fault-proof-program-development">Fault Proof Program Development</a></h1>
<p>This chapter provides an overview of <a href="fpp-dev/../glossary.html#fault-proof-program">Fault Proof Program</a>
development
on top of the custom FPVM targets supported by <a href="https://github.com/anton-rs/kona">Kona</a>.</p>
<p>At a high level, a Fault Proof Program is not much different from a regular <code>no_std</code> Rust program. A custom entrypoint is provided, and the program
is compiled down to a custom target, which is then executed on the FPVM.</p>
<p>Fault Proof Programs are structured with 3 stages:</p>
<ol>
<li><strong>Prologue</strong>: The bootstrapping stage, where the program is loaded into memory and the initial state is set up. During this phase, the program's initial
state is written to the FPVM's memory, and the program's entrypoint is set.</li>
<li><strong>Execution</strong>: The main execution stage, where the program is executed on the FPVM. During this phase, the program's entrypoint is called, and the
program is executed until it exits.</li>
<li><strong>Epilogue</strong>: The finalization stage, where the program's final state is read from the FPVM's memory. During this phase, the program's final state is
inspected and properties of the state transition are verified.</li>
</ol>
<p>The following sections will provide a more in-depth overview of each of these stages, as well as the tools and abstractions provided by Kona for
developing your own Fault Proof Programs.</p>
<!-- External -->
<!-- Kona links -->
<!-- People -->
<div style="break-before: page; page-break-before: always;"></div><h1 id="environment"><a class="header" href="#environment">Environment</a></h1>
<p>Before kicking off the development of your own <a href="fpp-dev/../glossary.html#fault-proof-program">Fault Proof Program</a>
,
it's important to understand the environment that your program will be running in.</p>
<p>The FPP runs on top of a custom FPVM target, which is typically a VM with a modified subset of an existing reduced instruction set architecture and a subset of Linux syscalls. The FPVM is designed to
execute verifiable programs, and commonly modifies the instruction set it is derived from as well as the internal representation of memory to support verifiable memory access, <code>client</code> (program)
communication with the <code>host</code> (the FPVM), and other implementation-specific features.</p>
<h2 id="host---client-communication"><a class="header" href="#host---client-communication">Host &lt;-&gt; Client Communication</a></h2>
<p>While the program is running on top of the FPVM, it is considered to be in the <code>client</code> role, while the VM is in the <code>host</code> role. The only way for the <code>client</code> and <code>host</code>
to communicate with one another is synchronously through the <a href="fpp-dev/../glossary.html#preimage-abi">Preimage ABI</a>
(<a href="https://specs.optimism.io/experimental/fault-proof/index.html#pre-image-oracle">specification</a>).</p>
<p>In order for the <code>client</code> to read from the <code>host</code>, the <code>read</code> and <code>write</code> syscalls are modified within the FPVM to allow the <code>client</code> to request preparation of and read foreign data.</p>
<h3 id="reading"><a class="header" href="#reading">Reading</a></h3>
<p>When the <code>client</code> wants to read data from the <code>host</code>, it must first send a "hint" to the <code>host</code> through the hint file descriptor, which signals a request for the <code>host</code> to prepare the data for reading. The <code>host</code> will then
prepare the data, and send a hint acknowledgement back to the <code>client</code>. The <code>client</code> can then read the data from the host through the designated file descriptor.</p>
<p>The preparation step ("hinting") is an optimization that allows the <code>host</code> to know ahead of time the intents of the <code>client</code> and the data it requires for execution. This can allow
for lazy loading of data, and also prevent the need for unnecessary allocations within the <code>host</code>'s memory. This step is a no-op on-chain, and is only ran locally
when the <code>host</code> is the native implementation of the FPVM.</p>
<center>
<pre class="mermaid">sequenceDiagram
    Client-&gt;&gt;+Host: Hint preimage (no-op on-chain / read-only mode)
    Host--&gt;&gt;Host: Prepare Preimage
    Host--&gt;&gt;-Client: Hint acknowledgement
    Client--&gt;&gt;+Host: Preimage Request
    Host--&gt;&gt;-Client: Preimage Data
</pre>
</center>
<h2 id="full-example"><a class="header" href="#full-example">Full Example</a></h2>
<p>Below, we have a full architecture diagram of the <a href="https://github.com/ethereum-optimism/optimism/tree/develop/op-program"><code>op-program</code></a> (source: <a href="https://specs.optimism.io/experimental/fault-proof/index.html">fault proof specs</a>), the reference implementation for the OP Stack's Fault Proof Program,
which has the objective of verifying claims about the state of an <a href="https://github.com/ethereum-optimism/optimism">OP Stack</a> layer two.</p>
<p><img src="fpp-dev/../assets/op-program-fpp.svg" alt="op-program-architecture" /></p>
<p>In this program, execution and derivation of the L2 chain is performed within it, and ultimately the claimed state of the L2 chain is verified in the <a href="fpp-dev/./prologue.html">prologue</a> stage.</p>
<p>It communicates with the <code>host</code> for two reasons:</p>
<ol>
<li>To request preparation of L1 and L2 state data preimages.</li>
<li>To read the L1 and L2 state data preimages that were prepared after the above requests.</li>
</ol>
<p>The <code>host</code> is responsible for:</p>
<ol>
<li>Preparing and maintaining a store of the L1 and L2 state data preimages, as well as localized bootstrap k/v pairs.</li>
<li>Providing the L1 and L2 state data preimages to the <code>client</code> for reading.</li>
</ol>
<p>Other programs (<code>clients</code>) may have different requirements for communication with the <code>host</code>, but the above is a common pattern for programs built on top of a FPVMs. In general:</p>
<ol>
<li>The <code>client</code> program is a state machine that is responsible for bootstrapping itself from the inputs, executing the progam logic, and verifying the outcome.</li>
<li>The <code>host</code> is responsible for providing the <code>client</code> with data it wasn't bootstrapped with, and for executing the program itself.</li>
</ol>
<!-- External -->
<!-- Kona links -->
<!-- People -->
<div style="break-before: page; page-break-before: always;"></div><h1 id="supported-targets"><a class="header" href="#supported-targets">Supported Targets</a></h1>
<p>Kona seeks to support all FPVM targets that LLVM and <code>rustc</code> can offer introductory support for. Below is a matrix of features that Kona offers
for each FPVM target:</p>
<div class="table-wrapper"><table><thead><tr><th>Target</th><th>Build Pipeline</th><th>IO</th><th>malloc</th><th>Program Stages</th></tr></thead><tbody>
<tr><td><code>cannon</code> &amp; <code>cannon-rs</code></td><td>✅</td><td>✅</td><td>✅</td><td>❌</td></tr>
<tr><td><code>asterisc</code></td><td>✅</td><td>✅</td><td>✅</td><td>❌</td></tr>
</tbody></table>
</div>
<p>If there is a feature that you would like to see supported, please <a href="https://github.com/anton-rs/kona/issues/new">open an issue</a> or <a href="https://github.com/anton-rs/kona/tree/main/CONTRIBUTING.md">consider contributing</a>!</p>
<h2 id="cannon-mips32r2"><a class="header" href="#cannon-mips32r2">Cannon (MIPS32r2)</a></h2>
<p>Cannon is based off of the <code>mips32r2</code> target architecture, supporting 55 instructions:</p>
<div class="table-wrapper"><table><thead><tr><th>Category</th><th>Instruction</th><th>Description</th></tr></thead><tbody>
<tr><td><code>Arithmetic</code></td><td><code>addi</code></td><td>Add immediate (with sign-extension).</td></tr>
<tr><td><code>Arithmetic</code></td><td><code>addiu</code></td><td>Add immediate unsigned (no overflow).</td></tr>
<tr><td><code>Arithmetic</code></td><td><code>addu</code></td><td>Add unsigned (no overflow).</td></tr>
<tr><td><code>Logical</code></td><td><code>and</code></td><td>Bitwise AND.</td></tr>
<tr><td><code>Logical</code></td><td><code>andi</code></td><td>Bitwise AND immediate.</td></tr>
<tr><td><code>Branch</code></td><td><code>b</code></td><td>Unconditional branch.</td></tr>
<tr><td><code>Conditional Branch</code></td><td><code>beq</code></td><td>Branch on equal.</td></tr>
<tr><td><code>Conditional Branch</code></td><td><code>beqz</code></td><td>Branch if equal to zero.</td></tr>
<tr><td><code>Conditional Branch</code></td><td><code>bgez</code></td><td>Branch on greater than or equal to zero.</td></tr>
<tr><td><code>Conditional Branch</code></td><td><code>bgtz</code></td><td>Branch on greater than zero.</td></tr>
<tr><td><code>Conditional Branch</code></td><td><code>blez</code></td><td>Branch on less than or equal to zero.</td></tr>
<tr><td><code>Conditional Branch</code></td><td><code>bltz</code></td><td>Branch on less than zero.</td></tr>
<tr><td><code>Conditional Branch</code></td><td><code>bne</code></td><td>Branch on not equal.</td></tr>
<tr><td><code>Conditional Branch</code></td><td><code>bnez</code></td><td>Branch if not equal to zero.</td></tr>
<tr><td><code>Logical</code></td><td><code>clz</code></td><td>Count leading zeros.</td></tr>
<tr><td><code>Arithmetic</code></td><td><code>divu</code></td><td>Divide unsigned.</td></tr>
<tr><td><code>Unconditional Jump</code></td><td><code>j</code></td><td>Jump.</td></tr>
<tr><td><code>Unconditional Jump</code></td><td><code>jal</code></td><td>Jump and link.</td></tr>
<tr><td><code>Unconditional Jump</code></td><td><code>jalr</code></td><td>Jump and link register.</td></tr>
<tr><td><code>Unconditional Jump</code></td><td><code>jr</code></td><td>Jump register.</td></tr>
<tr><td><code>Data Transfer</code></td><td><code>lb</code></td><td>Load byte.</td></tr>
<tr><td><code>Data Transfer</code></td><td><code>lbu</code></td><td>Load byte unsigned.</td></tr>
<tr><td><code>Data Transfer</code></td><td><code>lui</code></td><td>Load upper immediate.</td></tr>
<tr><td><code>Data Transfer</code></td><td><code>lw</code></td><td>Load word.</td></tr>
<tr><td><code>Data Transfer</code></td><td><code>lwr</code></td><td>Load word right.</td></tr>
<tr><td><code>Data Transfer</code></td><td><code>mfhi</code></td><td>Move from HI register.</td></tr>
<tr><td><code>Data Transfer</code></td><td><code>mflo</code></td><td>Move from LO register.</td></tr>
<tr><td><code>Data Transfer</code></td><td><code>move</code></td><td>Move between registers.</td></tr>
<tr><td><code>Data Transfer</code></td><td><code>movn</code></td><td>Move conditional on not zero.</td></tr>
<tr><td><code>Data Transfer</code></td><td><code>movz</code></td><td>Move conditional on zero.</td></tr>
<tr><td><code>Data Transfer</code></td><td><code>mtlo</code></td><td>Move to LO register.</td></tr>
<tr><td><code>Arithmetic</code></td><td><code>mul</code></td><td>Multiply (to produce a word result).</td></tr>
<tr><td><code>Arithmetic</code></td><td><code>multu</code></td><td>Multiply unsigned.</td></tr>
<tr><td><code>Arithmetic</code></td><td><code>negu</code></td><td>Negate unsigned.</td></tr>
<tr><td><code>No Op</code></td><td><code>nop</code></td><td>No operation.</td></tr>
<tr><td><code>Logical</code></td><td><code>not</code></td><td>Bitwise NOT (pseudo-instruction in MIPS).</td></tr>
<tr><td><code>Logical</code></td><td><code>or</code></td><td>Bitwise OR.</td></tr>
<tr><td><code>Logical</code></td><td><code>ori</code></td><td>Bitwise OR immediate.</td></tr>
<tr><td><code>Data Transfer</code></td><td><code>sb</code></td><td>Store byte.</td></tr>
<tr><td><code>Logical</code></td><td><code>sll</code></td><td>Shift left logical.</td></tr>
<tr><td><code>Logical</code></td><td><code>sllv</code></td><td>Shift left logical variable.</td></tr>
<tr><td><code>Comparison</code></td><td><code>slt</code></td><td>Set on less than (signed).</td></tr>
<tr><td><code>Comparison</code></td><td><code>slti</code></td><td>Set on less than immediate.</td></tr>
<tr><td><code>Comparison</code></td><td><code>sltiu</code></td><td>Set on less than immediate unsigned.</td></tr>
<tr><td><code>Comparison</code></td><td><code>sltu</code></td><td>Set on less than unsigned.</td></tr>
<tr><td><code>Logical</code></td><td><code>sra</code></td><td>Shift right arithmetic.</td></tr>
<tr><td><code>Logical</code></td><td><code>srl</code></td><td>Shift right logical.</td></tr>
<tr><td><code>Logical</code></td><td><code>srlv</code></td><td>Shift right logical variable.</td></tr>
<tr><td><code>Arithmetic</code></td><td><code>subu</code></td><td>Subtract unsigned.</td></tr>
<tr><td><code>Data Transfer</code></td><td><code>sw</code></td><td>Store word.</td></tr>
<tr><td><code>Data Transfer</code></td><td><code>swr</code></td><td>Store word right.</td></tr>
<tr><td><code>Serialization</code></td><td><code>sync</code></td><td>Synchronize shared memory.</td></tr>
<tr><td><code>System Calls</code></td><td><code>syscall</code></td><td>System call.</td></tr>
<tr><td><code>Logical</code></td><td><code>xor</code></td><td>Bitwise XOR.</td></tr>
<tr><td><code>Logical</code></td><td><code>xori</code></td><td>Bitwise XOR immediate.</td></tr>
</tbody></table>
</div>
<h3 id="syscalls"><a class="header" href="#syscalls">Syscalls</a></h3>
<div class="table-wrapper"><table><thead><tr><th>$v0</th><th>system call</th><th>$a0</th><th>$a1</th><th>$a2</th><th>Effect</th></tr></thead><tbody>
<tr><td>4090</td><td>mmap</td><td>uint32 addr</td><td>uint32 len</td><td>🚫</td><td>Allocates a page from the heap. See <a href="fpp-dev/targets.html#heap">heap</a> for details.</td></tr>
<tr><td>4045</td><td>brk</td><td>🚫</td><td>🚫</td><td>🚫</td><td>Returns a fixed address for the program break at <code>0x40000000</code></td></tr>
<tr><td>4120</td><td>clone</td><td>🚫</td><td>🚫</td><td>🚫</td><td>Returns 1</td></tr>
<tr><td>4246</td><td>exit_group</td><td>uint8 exit_code</td><td>🚫</td><td>🚫</td><td>Sets the Exited and ExitCode states to <code>true</code> and <code>$a0</code> respectively.</td></tr>
<tr><td>4003</td><td>read</td><td>uint32 fd</td><td>char *buf</td><td>uint32 count</td><td>Similar behavior as Linux/MIPS with support for unaligned reads. See <a href="fpp-dev/targets.html#io">I/O</a> for more details.</td></tr>
<tr><td>4004</td><td>write</td><td>uint32 fd</td><td>char *buf</td><td>uint32 count</td><td>Similar behavior as Linux/MIPS with support for unaligned writes. See <a href="fpp-dev/targets.html#io">I/O</a> for more details.</td></tr>
<tr><td>4055</td><td>fcntl</td><td>uint32 fd</td><td>int32 cmd</td><td>🚫</td><td>Similar behavior as Linux/MIPS. Only the <code>F_GETFL</code> (3) cmd is supported. Sets errno to <code>0x16</code> for all other commands</td></tr>
</tbody></table>
</div>
<p>For all of the above syscalls, an error is indicated by setting the return
register (<code>$v0</code>) to <code>0xFFFFFFFF</code> (-1) and <code>errno</code> (<code>$a3</code>) is set accordingly.
The VM must not modify any register other than <code>$v0</code> and <code>$a3</code> during syscall handling.
For unsupported syscalls, the VM must do nothing except to zero out the syscall return (<code>$v0</code>)
and errno (<code>$a3</code>) registers.</p>
<p>Note that the above syscalls have identical syscall numbers and ABIs as Linux/MIPS.</p>
<h2 id="asterisc-risc-v"><a class="header" href="#asterisc-risc-v">Asterisc (RISC-V)</a></h2>
<p>Asterisc is based off of the <code>rv64gc</code> target architecture, which defines the following extensions:</p>
<ul>
<li><code>RV32I</code> support - 32 bit base instruction set
<ul>
<li><code>FENCE</code>, <code>ECALL</code>, <code>EBREAK</code> are hardwired to implement a minimal subset of systemcalls of the linux kernel
<ul>
<li>Work in progress. All syscalls used by the Golang <code>risc64</code> runtime.</li>
</ul>
</li>
</ul>
</li>
<li><code>RV64I</code> support</li>
<li><code>RV64C</code>: Compressed instructions</li>
<li><code>RV32M</code>+<code>RV64M</code>: Multiplication support</li>
<li><code>RV32A</code>+<code>RV64A</code>: Atomics support</li>
<li><code>RV{32,64}{D,F,Q}</code>: no-op: No floating points support (since no IEEE754 determinism with rounding modes etc., nor worth the complexity)</li>
<li><code>Zifencei</code>: <code>FENCE.I</code> no-op: No need for <code>FENCE.I</code></li>
<li><code>Zicsr</code>: no-op: some support for Control-and-status registers may come later though.</li>
<li><code>Ztso</code>: no-op: no need for Total Store Ordering</li>
<li>other: revert with error code on unrecognized instructions</li>
</ul>
<p><code>asterisc</code> supports a plethora of syscalls, documented <a href="https://github.com/ethereum-optimism/asterisc">in the repository</a>. <code>kona</code> offers an interface for
programs to directly invoke a select few syscalls:</p>
<ol>
<li><code>EXIT</code> - Terminate the process with the provided exit code.</li>
<li><code>WRITE</code> - Write the passed buffer to the passed file descriptor.</li>
<li><code>READ</code> - Read the specified number of bytes from the passed file descriptor.</li>
</ol>
<!-- External -->
<!-- Kona links -->
<!-- People -->
<div style="break-before: page; page-break-before: always;"></div><h1 id="prologue"><a class="header" href="#prologue">Prologue</a></h1>
<p>The prologue stage of the program is commonly responsible for bootstrapping the program with inputs from an external
source, pulled in through the <a href="fpp-dev/./env.html#host---client-communication">Host &lt;-&gt; Client communication</a> implementation.</p>
<p>As a rule of thumb, the prologue implementation should be kept minimal, and should not do much more than establish
the inputs for the <a href="fpp-dev/./execution.html">execution phase</a>.</p>
<h2 id="example"><a class="header" href="#example">Example</a></h2>
<p>As an example, the prologue stage of the <code>kona-client</code> program runs through several steps:</p>
<ol>
<li>Pull in the boot information over the <a href="https://specs.optimism.io/experimental/fault-proof/index.html#pre-image-oracle">Preimage Oracle ABI</a>, containing:
<ul>
<li>The L1 head hash containing all data required to reproduce the L2 safe chain at the claimed block height.</li>
<li>The latest finalized <a href="https://specs.optimism.io/protocol/proposals.html#l2-output-commitment-construction">L2 output root</a>.</li>
<li>The <a href="https://specs.optimism.io/protocol/proposals.html#l2-output-commitment-construction">L2 output root</a> claim.</li>
<li>The block number of the <a href="https://specs.optimism.io/protocol/proposals.html#l2-output-commitment-construction">L2 output root</a> claim.</li>
<li>The L2 chain ID.</li>
</ul>
</li>
<li>Pull in the <code>RollupConfig</code> and <code>L2ChainConfig</code> corresponding to the passed L2 chain ID.</li>
<li>Validate these values.</li>
<li>Pass the boot information to the execution phase.</li>
</ol>
<!-- External -->
<!-- Kona links -->
<!-- People -->
<div style="break-before: page; page-break-before: always;"></div><h1 id="execution"><a class="header" href="#execution">Execution</a></h1>
<p>The execution phase of the program is commonly the heaviest portion of the fault proof program, where the computation
that is being verified is performed.</p>
<p>This phase consumes the outputs of the <a href="fpp-dev/./prologue.html">prologue phase</a>, and performs the bulk of the verifiable
computation. After execution has concluded, the outputs are passed along to the <a href="fpp-dev/./epilogue.html">epilogue phase</a> for
final verification.</p>
<h2 id="example-1"><a class="header" href="#example-1">Example</a></h2>
<p>At a high-level, in the <code>kona-client</code> program, the execution phase:</p>
<ol>
<li>Derives the inputs to the L2 derivation pipeline by unrolling the L1 head hash fetched in the epilogue.</li>
<li>Passes the inputs to the L2 derivation pipeline, producing the L2 execution payloads required to reproduce
the L2 safe chain at the claimed height.</li>
<li>Executes the payloads produced by the L2 derivation pipeline, producing the <a href="https://specs.optimism.io/protocol/proposals.html#l2-output-commitment-construction">L2 output root</a> at the
L2 claim height.</li>
</ol>
<!-- External -->
<!-- Kona links -->
<!-- People -->
<div style="break-before: page; page-break-before: always;"></div><h1 id="epilogue"><a class="header" href="#epilogue">Epilogue</a></h1>
<p>The epilogue stage of the program is intended to perform the final validation on the outputs from the
<a href="fpp-dev/./execution.html">execution phase</a>. In most programs, this entails comparing the outputs of the execution phase
to portions of the bootstrap data made available during the <a href="fpp-dev/./prologue.html">prologue phase</a>.</p>
<p>Generally, this phase should consist almost entirely of validation steps.</p>
<h2 id="example-2"><a class="header" href="#example-2">Example</a></h2>
<p>In the <code>kona-client</code> program, the prologue phase only contains two directives:</p>
<ol>
<li>Validate that the L2 safe chain could be produced at the claimed L2 block height.</li>
<li>The constructed output root is equivalent to the claimed <a href="https://specs.optimism.io/protocol/proposals.html#l2-output-commitment-construction">L2 output root</a>.</li>
</ol>
<!-- External -->
<!-- Kona links -->
<!-- People -->
<div style="break-before: page; page-break-before: always;"></div><h1 id="glossary"><a class="header" href="#glossary">Glossary</a></h1>
<p><em>This document contains definitions for terms used throughout the Kona book.</em></p>
<h4 id="fault-proof-vm"><a class="header" href="#fault-proof-vm">Fault Proof VM</a></h4>
<p>A <code>Fault Proof VM</code> is a virtual machine, commonly supporting a subset of the Linux kernel's syscalls and a modified subset of an existing reduced instruction set architecture,
that is designed to execute verifiable programs.</p>
<p>Full specification for the <code>cannon</code> &amp; <code>cannon-rs</code> FPVMs, as an example, is available in the <a href="https://specs.optimism.io/experimental/fault-proof/cannon-fault-proof-vm.html#cannon-fault-proof-virtual-machine">Optimism Monorepo</a>.</p>
<h4 id="fault-proof-program"><a class="header" href="#fault-proof-program">Fault Proof Program</a></h4>
<p>A <code>Fault Proof Program</code> is a program, commonly written in a general purpose language such as Golang, C, or Rust, that may be compiled down
to a compatible <code>Fault Proof VM</code> target and provably executed on that target VM.</p>
<p>Examples of <code>Fault Proof Programs</code> include the <a href="https://github.com/ethereum-optimism/optimism/tree/develop/op-program">OP Program</a>, which runs on top of <a href="https://github.com/ethereum-optimism/optimism/tree/develop/cannon"><code>cannon</code></a>, <a href="https://github.com/anton-rs/cannon-rs"><code>cannon-rs</code></a>, and
<a href="https://github.com/ethereum-optimism/asterisc"><code>asterisc</code></a> to verify a claim about the state of an <a href="https://github.com/ethereum-optimism/optimism">OP Stack</a> layer two.</p>
<h4 id="preimage-abi"><a class="header" href="#preimage-abi">Preimage ABI</a></h4>
<p>The <code>Preimage ABI</code> is a specification for a synchronous communication protocol between a <code>client</code> and a <code>host</code> that is used to request and read data from the <code>host</code>'s
datastore. Full specifications for the <code>Preimage ABI</code> are available in the <a href="https://specs.optimism.io/experimental/fault-proof/index.html#pre-image-oracle">Optimism Monorepo</a>.</p>
<!-- External -->
<!-- Kona links -->
<!-- People -->
<div style="break-before: page; page-break-before: always;"></div><h1 id="contributing-1"><a class="header" href="#contributing-1">Contributing</a></h1>
<p>Thank you for wanting to contribute! Before contributing to this repository, please read through this document and
discuss the change you wish to make via issue or in the development telegram.</p>
<h2 id="dependencies"><a class="header" href="#dependencies">Dependencies</a></h2>
<p>Before working with this repository locally, you'll need to install several dependencies:</p>
<ul>
<li><a href="https://www.docker.com/">Docker</a> for cross-compilation.</li>
<li><a href="https://github.com/casey/just">just</a> for our command-runner scripts.</li>
<li>The <a href="https://rustup.rs/">Rust toolchain</a></li>
<li>The <a href="https://go.dev/dl/">Golang toolchain</a></li>
</ul>
<p><strong>Optional</strong></p>
<ul>
<li><a href="https://github.com/rust-lang/mdBook">mdbook</a> to contribute to the <a href="/">book</a>
<ul>
<li><a href="https://github.com/sgoudham/mdbook-template">mdbook-template</a></li>
<li><a href="https://github.com/badboy/mdbook-mermaid">mdbook-mermaid</a></li>
</ul>
</li>
</ul>
<h2 id="pull-request-process"><a class="header" href="#pull-request-process">Pull Request Process</a></h2>
<ol>
<li>Before anything, <a href="https://github.com/anton-rs/kona/issues/new">create an issue</a> to discuss the change you're
wanting to make, if it is significant or changes functionality. Feel free to skip this step for trivial changes.</li>
<li>Once your change is implemented, ensure that all checks are passing before creating a PR. The full CI pipeline can
be ran locally via the <code>justfile</code>s in the repository.</li>
<li>Make sure to update any documentation that has gone stale as a result of the change, in the <code>README</code> files, the [book][book],
and in rustdoc comments.</li>
<li>Once you have sign-off from a maintainer, you may merge your pull request yourself if you have permissions to do so.
If not, the maintainer who approves your pull request will add it to the merge queue.</li>
</ol>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->
        <script src="mermaid.min.js"></script>
        <script src="mermaid-init.js"></script>

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </div>
    </body>
</html>
